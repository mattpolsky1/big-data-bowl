```{r}
# This file is data prep for shiny app. Run this before running app.R.

library(dplyr)
library(xgboost)

# Prepare supp (play-level info for filtering)
# ============================================================================

cat("Step 1: Preparing supp...\n")

supp_clean <- supp %>%
  mutate(
    game_id = as.character(game_id),
    # Rename columns to match app expectations
    posteam = possession_team,
    defteam = defensive_team,
    ydstogo = yards_to_go,
    desc = play_description,
    # Calculate yardline_100 (distance from opponent's end zone)
    yardline_100 = case_when(
      yardline_side == posteam ~ 100 - yardline_number,
      yardline_side == defteam ~ yardline_number,
      TRUE ~ 50  
    )
  ) %>%
  # Join ball landing locations
  left_join(
    play_info_from_input %>%
      mutate(game_id = as.character(game_id)) %>%
      select(game_id, play_id, ball_land_x_std, ball_land_y_std),
    by = c("game_id", "play_id")
  ) %>%
  # Only keep plays that exist in sequential model data
  semi_join(
    sequential_model_data_final %>% 
      mutate(game_id = as.character(game_id)) %>%
      distinct(game_id, play_id),
    by = c("game_id", "play_id")
  ) %>%
  select(
    week, game_id, play_id, posteam, defteam, quarter, down, ydstogo,
    yardline_100, desc, ball_land_x_std, ball_land_y_std,
    home_team_abbr, visitor_team_abbr, pass_result
  )

cat("  Plays in supp_clean:", nrow(supp_clean), "\n")

# Create player_info from players
# ============================================================================


player_info <- players %>%
  select(
    nfl_id,
    display_name,
    position,
    headshot
  ) %>%
  distinct(nfl_id, .keep_all = TRUE)

cat("  Players in player_info:", nrow(player_info), "\n")

# Prepare sequential_model_data_final
# ============================================================================

cat("Step 3: Preparing sequential model data...\n")

# Check if we need to add coordinates
if(!"x_std" %in% names(sequential_model_data_final)) {
  cat("  WARNING: x_std and y_std not found in sequential_model_data_final\n")
  cat("  You need to add coordinates from your tracking data.\n")
  cat("  See note at end of script.\n")
}

# Check if we need to add predictions
if(!"pred_prob_pd" %in% names(sequential_model_data_final)) {
  cat("  Adding model predictions...\n")
  
  # Define features (excluding distance_to_qb_now if it causes issues)
  sequential_features_clean <- c(
    "player_position", "coverage_responsibility", "alignment",
    "down", "yards_to_go", "pass_length", "play_action", "dropback_type", "dropback_distance",
    "distance_to_ball_now", "angle_diff_to_ball_now", "velocity_toward_ball_now",
    "s", "dir_std", "o_std",
    "frames_since_break", "frames_until_arrival", "time_to_arrival",
    "required_speed_now", "speed_surplus_now",
    "cumulative_distance", "distance_closed", "closure_rate",
    "avg_speed_so_far", "max_speed_so_far",
    "num_direction_changes_so_far", "path_efficiency_so_far",
    "distance_to_receiver", "angle_diff_to_receiver", "between_ball_receiver",
    "distance_to_defender_1", "distance_to_defender_2", "distance_to_defender_3",
    "num_nearby_defenders", "closest_defender_distance", "is_closest_to_ball"
  )
  
  categorical_vars <- c("player_position", "coverage_responsibility", "alignment",
                        "dropback_type", "play_action", "pass_length")
  
  # Prepare data for prediction
  seq_for_pred <- sequential_model_data_final %>%
    mutate(across(all_of(categorical_vars), ~as.numeric(as.factor(.))))
  
  # Create prediction matrix
  X_all <- seq_for_pred %>%
    select(all_of(sequential_features_clean)) %>%
    as.matrix()
  
  d_all <- xgb.DMatrix(data = X_all)
  
  # Add predictions (make sure xgb_model and xgb_model_tackles are loaded)
  sequential_model_data_final$pred_prob_pd <- predict(xgb_model, d_all)
  sequential_model_data_final$pred_prob_tkl <- predict(xgb_model_tackles, d_all)
  
  cat("  Predictions added.\n")
} else {
  cat("  Predictions already exist.\n")
}

xgb_model

# Ensure game_id is character
sequential_model_data_final <- sequential_model_data_final %>%
  mutate(game_id = as.character(game_id))

cat("  Rows in sequential_model_data_final:", nrow(sequential_model_data_final), "\n")
cat("  Unique plays:", n_distinct(sequential_model_data_final$game_id, sequential_model_data_final$play_id), "\n")

# Prepare percentile metrics
# ============================================================================

cat("Step 4: Preparing percentile metrics...\n")

# These should already exist from your code, just ensure they're ready
all_break_metrics <- all_break_metrics %>%
  mutate(
    break_rate_oe = round(break_rate_oe * 100, 1),
    break_oe_pctl = round(break_oe_pctl, 0)
  )

all_speed_metrics <- all_speed_metrics %>%
  mutate(
    frames_oe = round(frames_oe, 2),
    frames_oe_pctl = round(frames_oe_pctl, 0)
  )

all_path_metrics <- all_path_metrics %>%
  mutate(
    avg_pd_gain = round(avg_pd_gain * 100, 1),
    avg_tkl_gain = round(avg_tkl_gain * 100, 1),
    pd_gain_pctl = round(pd_gain_pctl, 0),
    tkl_gain_pctl = round(tkl_gain_pctl, 0)
  )

cat("  Break metrics players:", nrow(all_break_metrics), "\n")
cat("  Speed metrics players:", nrow(all_speed_metrics), "\n")
cat("  Path metrics players:", nrow(all_path_metrics), "\n")

# rename for app
# ============================================================================

supp <- supp_clean

# save data
# ============================================================================

cat("\nStep 6: Saving data...\n")

save(
  supp,
  sequential_model_data_final,
  player_info,
  teams_colors_logos,
  all_break_metrics,
  all_speed_metrics,
  all_path_metrics,
  play_info_from_input,
  xgb_model,
  xgb_model_tackles,
  file = "shiny_app_data.RData"
)



```


